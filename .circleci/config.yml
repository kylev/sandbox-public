version: 2.1

orbs:
  aws-s3: circleci/aws-s3@1.0.12
  docker: circleci/docker@0.5.20

jobs:
  rubyapp_test:
    docker:
      - image: circleci/ruby:2.6.5
    steps:
      - checkout
      - restore_cache:
          key: sandbox-rubyapp-{{ checksum "rubyapp/Gemfile.lock" }}
      - run:
          name: Test
          command: |
            cd rubyapp
            bundle check --path vendor/bundle || bundle install --path vendor/bundle

            mkdir -p ~/results
            bundle exec rspec --format progress --format RspecJunitFormatter -o ~/results/rspec.xml
      - save_cache:
          key: sandbox-rubyapp-{{ checksum "rubyapp/Gemfile.lock" }}
          paths:
            - rubyapp/vendor/bundle
      - store_test_results:
          path: ~/results

  opsbot_test:
    docker:
      - image: circleci/python:3.8.0
    steps:
      - checkout
      - restore_cache:
          key: sandbox-opsbot-{{ checksum "opsbot/requirements.txt" }}
      - run:
          name: nosetests
          command: |
            cd opsbot
            pip install --user -r requirements.txt
            pip install --user -e .

            mkdir -p ~/results/nose
            nosetests --with-xunit --xunit-file ~/results/nose.xml
      - save_cache:
          key: sandbox-opsbot-{{ checksum "opsbot/requirements.txt" }}
          paths:
            - ~/.cache/pip
            - ~/.local
      - store_test_results:
          path: ~/results

  rubyapp_package:
    docker:
      - image: circleci/python
    steps:
      - setup_remote_docker
      - checkout
      - docker/build:
          image: kylev/sandbox-rubyapp
          path: rubyapp

  opsbot_package:
    docker:
      - image: circleci/python
    steps:
      - checkout
      - run:
          name: Zip for Lambda
          command: |
            cd opsbot
            make package
      - run:
          name: Examine
          command: unzip -l ~/lambda.zip
      - aws-s3/copy:
          from: ~/lambda.zip
          to: s3://kylev-utility/opsbot/lambda.zip
          arguments: --dryrun

  cd:
    docker:
      - image: circleci/python
    steps:
      - run:
          name: TODO Deploy?
          command: |
            echo Lots to do here.


workflows:
  version: 2
  ci:
    jobs:
      - rubyapp_test
      - opsbot_test
      - rubyapp_package
      - opsbot_package
      - cd:
          requires:
            - rubyapp_test
            - opsbot_test
            - rubyapp_package
            - opsbot_package
